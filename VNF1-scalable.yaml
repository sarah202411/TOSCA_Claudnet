tosca_definitions_version: tosca_simple_yaml_1_3
description: Firewall VM-based scalable et tol√©rant aux pannes avec 2 composants (Main & Mgmt)

imports:
  - etsi_nfv_sol001_vnfd_types.yaml

node_types:
  tosca.nodes.nfv.Firewall_VNF:
    derived_from: tosca.nodes.nfv.VNF
    properties:
      descriptor_id:
        type: string
        default: firewall-vnfd-1.0
      provider:
        type: string
        default: MyCompany
      product_name:
        type: string
        default: Firewall_VM
      software_version:
        type: string
        default: '1.0'
      descriptor_version:
        type: string
        default: '1.0'
      flavour_id:
        type: string
        default: scalable_ha
      flavour_description:
        type: string
        default: "Scalable flavour with HA support for Firewall"
      vnfm_info:
        type: list
        entry_schema:
          type: string
        default: ['etsivnfm:v3.3.1']
    requirements:
      - virtual_link_external:
          capability: tosca.capabilities.nfv.VirtualLinkable
          relationship: tosca.relationships.nfv.VirtualLinksTo

topology_template:
  inputs:
    firewall_main_flavour:
      type: string
      default: m1.medium
    firewall_mgmt_flavour:
      type: string
      default: m1.small

  substitution_mappings:
    node_type: tosca.nodes.nfv.Firewall_VNF
    requirements:
      virtual_link_external: [extCp_mgmt, internal_virtual_link]

  node_templates:
    # External Connection Point (Management)
    extCp_mgmt:
      type: tosca.nodes.nfv.VnfExtCp
      properties:
        layer_protocols: [ipv4]
        description: Firewall Management interface

    # Internal Virtual Links
    intVL_mgmt:
      type: tosca.nodes.nfv.VnfVirtualLink
      properties:
        connectivity_type:
          layer_protocols: [ipv4]
        description: Firewall Management network
        vl_profile:
          max_bitrate_requirements:
            root: 1000000
            leaf: 100000
          min_bitrate_requirements:
            root: 100000
            leaf: 10000

    intVL_data:
      type: tosca.nodes.nfv.VnfVirtualLink
      properties:
        connectivity_type:
          layer_protocols: [ipv4]
        description: Firewall Data plane network
        vl_profile:
          max_bitrate_requirements:
            root: 10000000
            leaf: 1000000
          min_bitrate_requirements:
            root: 1000000
            leaf: 100000

    # Component 1 - VDU (Firewall Main Engine)
    vdu_firewall_main:
      type: tosca.nodes.nfv.Vdu.Compute
      properties:
        name: firewall-main
        description: Firewall Main Inspection Engine
        vdu_profile:
          min_number_of_instances: 2
          max_number_of_instances: 5
      capabilities:
        virtual_compute:
          properties:
            virtual_memory:
              virtual_mem_size: 4 GB
            virtual_cpu:
              num_virtual_cpu: 2
            virtual_local_storage:
              - size_of_storage: 40 GB
      artifacts:
        sw_image:
          type: tosca.artifacts.nfv.SwImage
          file: firewall-main-image.qcow2
          properties:
            name: firewall-main-os
            version: '1.0'
            checksum:
              algorithm: sha-256
              hash: 1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef
            container_format: bare
            disk_format: qcow2
            min_disk: 10 GB
            size: 2 GB

    # Component 2 - VDU (Firewall Management Unit)
    vdu_firewall_mgmt:
      type: tosca.nodes.nfv.Vdu.Compute
      properties:
        name: firewall-mgmt
        description: Firewall Management and Logs Unit
        vdu_profile:
          min_number_of_instances: 2
          max_number_of_instances: 4
      capabilities:
        virtual_compute:
          properties:
            virtual_memory:
              virtual_mem_size: 8 GB
            virtual_cpu:
              num_virtual_cpu: 4
            virtual_local_storage:
              - size_of_storage: 100 GB
      artifacts:
        sw_image:
          type: tosca.artifacts.nfv.SwImage
          file: firewall-mgmt-image.qcow2
          properties:
            name: firewall-mgmt-os
            version: '1.0'
            checksum:
              algorithm: sha-256
              hash: abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890
            container_format: bare
            disk_format: qcow2
            min_disk: 20 GB
            size: 3 GB

    # Connection Points for Firewall Main
    cp_firewall_main_mgmt:
      type: tosca.nodes.nfv.VduCp
      properties:
        layer_protocols: [ipv4]
        order: 0
      requirements:
        - virtual_binding: vdu_firewall_main
        - virtual_link: intVL_mgmt

    cp_firewall_main_data:
      type: tosca.nodes.nfv.VduCp
      properties:
        layer_protocols: [ipv4]
        order: 1
      requirements:
        - virtual_binding: vdu_firewall_main
        - virtual_link: intVL_data

    # Connection Points for Firewall Management
    cp_firewall_mgmt_mgmt:
      type: tosca.nodes.nfv.VduCp
      properties:
        layer_protocols: [ipv4]
        order: 0
      requirements:
        - virtual_binding: vdu_firewall_mgmt
        - virtual_link: intVL_mgmt

    cp_firewall_mgmt_data:
      type: tosca.nodes.nfv.VduCp
      properties:
        layer_protocols: [ipv4]
        order: 1
      requirements:
        - virtual_binding: vdu_firewall_mgmt
        - virtual_link: intVL_data

  policies:
    - scaling_aspects:
        type: tosca.policies.nfv.ScalingAspects
        properties:
          aspects:
            firewall_main_scaling:
              name: firewall_main_scaling_aspect
              description: Scaling for main inspection engine
              max_scale_level: 3
              step_deltas:
                - delta_1
            firewall_mgmt_scaling:
              name: firewall_mgmt_scaling_aspect
              description: Scaling for management unit
              max_scale_level: 2
              step_deltas:
                - delta_1

    - vdu_firewall_main_initial_delta:
        type: tosca.policies.nfv.VduInitialDelta
        properties:
          initial_delta:
            number_of_instances: 2
        targets: [vdu_firewall_main]

    - vdu_firewall_main_scaling_delta:
        type: tosca.policies.nfv.VduScalingAspectDeltas
        properties:
          aspect: firewall_main_scaling
          deltas:
            delta_1:
              number_of_instances: 1
        targets: [vdu_firewall_main]

    - vdu_firewall_mgmt_initial_delta:
        type: tosca.policies.nfv.VduInitialDelta
        properties:
          initial_delta:
            number_of_instances: 2
        targets: [vdu_firewall_mgmt]

    - vdu_firewall_mgmt_scaling_delta:
        type: tosca.policies.nfv.VduScalingAspectDeltas
        properties:
          aspect: firewall_mgmt_scaling
          deltas:
            delta_1:
              number_of_instances: 1
        targets: [vdu_firewall_mgmt]

    - instantiation_levels:
        type: tosca.policies.nfv.InstantiationLevels
        properties:
          levels:
            default:
              description: Default instantiation level
              scale_info:
                firewall_main_scaling:
                  scale_level: 0
                firewall_mgmt_scaling:
                  scale_level: 0
            medium:
              description: Medium instantiation level
              scale_info:
                firewall_main_scaling:
                  scale_level: 1
                firewall_mgmt_scaling:
                  scale_level: 1
            large:
              description: Large instantiation level
              scale_info:
                firewall_main_scaling:
                  scale_level: 3
                firewall_mgmt_scaling:
                  scale_level: 2
          default_level: default

    - vdu_firewall_main_instantiation_levels:
        type: tosca.policies.nfv.VduInstantiationLevels
        properties:
          levels:
            default:
              number_of_instances: 2
            medium:
              number_of_instances: 3
            large:
              number_of_instances: 5
        targets: [vdu_firewall_main]

    - vdu_firewall_mgmt_instantiation_levels:
        type: tosca.policies.nfv.VduInstantiationLevels
        properties:
          levels:
            default:
              number_of_instances: 2
            medium:
              number_of_instances: 3
            large:
              number_of_instances: 4
        targets: [vdu_firewall_mgmt]
